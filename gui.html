<!DOCTYPE html>
<html>
  <body>
    <h1>Simple ROS User Interface</h1>
    <p>Connection status: <span id="status"></span></p>
    <p>Last /txt_msg received: <span id="msg"></span></p>
    <div id="zone_joystick" style="position: relative;"></div>
    <!-- Add toggle button between views -->
    <div><img id="my_image" style='height: 50%; width: 50%; object-fit: fill' src="assets/img/placeholder.png"></div>
    <div><img id="my_image_frontal" style='height: 50%; width: 50%; object-fit: fill' src="assets/img/pr.png"></div>
    <h1>Reward received: <span id="rew"></span></h1>
  </body>
<head>
  <meta charset="utf-8" />

  <script type="text/javascript" src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.js"></script>
  <script type="text/javascript" type="text/javascript">

    // Connecting to ROS
    var ros = new ROSLIB.Ros({
      url: 'ws://localhost:9090'
    });

    ros.on('connection', function () {
      console.log('Connected to websocket server.');
    });

    ros.on('error', function (error) {
      console.log('Error connecting to websocket server: ', error);
    });

    ros.on('close', function () {
      console.log('Connection to websocket server closed.');
    });


  // --------------------------------------------- //
  // --------------P/N Functionality START---------------//
  let rewardRendered = document.getElementById('rew');
  var reward = 0;

  document.addEventListener('keydown', function(e) {
    switch(e.keyCode) {
        case 80: //'p' is pressed
          reward = reward + 100;
          break;
        case 78: //'n' is pressed
          reward = reward - 100;
          break;
    }
    rewardRendered.innerHTML = reward;
  })
  // --------------------------------------------- //
  // --------------P/N Functionality END---------------//

    cmd_vel_listener = new ROSLIB.Topic({
      ros: ros,
      name: "/cmd_vel",
      messageType: 'geometry_msgs/Twist'
    });

    move = function (linear, angular) {
      var twist = new ROSLIB.Message({
        linear: {
          x: linear,
          y: 0,
          z: 0
        },
        angular: {
          x: 0,
          y: 0,
          z: angular
        }
      });
      cmd_vel_listener.publish(twist);
    }

    // Arrow Keys Functionality
    document.addEventListener('keydown', function (e) {
      switch (e.keyCode) {
        case 37:
          move(0, 1.0)
          break;
        case 38:
          move(1.0, 0)
          break;
        case 39:
          move(0, -1.0)
          break;
        case 40:
          move(-1.0, 0)
          break;
      }
    });

    createJoystick = function () {
      var options = {
        zone: document.getElementById('zone_joystick'),
        threshold: 0.1,
        position: { left: 50 + '%' },
        mode: 'static',
        size: 150,
        color: '#000000',
      };
      
      manager = nipplejs.create(options);

      linear_speed = 0;
      angular_speed = 0;

      self.manager.on('start', function (event, nipple) {
        timer = setInterval(function () {
          move(linear_speed, angular_speed);
        }, 25);
      });

      self.manager.on('end', function () {
        if (timer) {
          clearInterval(timer);
        }
        self.move(0, 0);
      });

      manager.on('move', function (event, nipple) {
        max_linear = 5.0; // m/s
        max_angular = 2.0; // rad/s
        max_distance = 75.0; // pixels;
        linear_speed = Math.sin(nipple.angle.radian) * max_linear * nipple.distance / max_distance;
        angular_speed = -Math.cos(nipple.angle.radian) * max_angular * nipple.distance / max_distance;
      });

      self.manager.on('end', function () {
        console.log("Movement end");
      });
    }

    window.onload = function () {
      createJoystick();
    }

    var image_topic = new ROSLIB.Topic({
      ros: ros, name: '/camera/image/compressed',
      messageType: 'sensor_msgs/CompressedImage'
    });

    image_topic.subscribe(function (message) {
      document.getElementById('my_image').src = "data:image/jpg;base64," + message.data;
      //image_topic.unsubscribe();
    });
    var image_topic_frontal = new ROSLIB.Topic({
      ros: ros, name: '/camera/rgb/image_raw/compressed',
      messageType: 'sensor_msgs/CompressedImage'
    });    
    image_topic_frontal.subscribe(function(message){
      document.getElementById('my_image_frontal').src = "data:image/jpg;base64,"+message.data;
    })


  </script>
</head>

</html>